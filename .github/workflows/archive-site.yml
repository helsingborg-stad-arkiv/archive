name: Archive Website

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Enter the full URL of the website to archive (e.g. https://example.com)"
        required: true
        type: string
      extra_domains:
        description: "Enter extra domains to include (comma-separated), e.g. media.example.com,cdn.example.com"
        required: false
        type: string

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xmlstarlet

      - name: Prepare archive folder
        run: mkdir -p archive

      - name: Archive site content
        env:
          SITE_URL: ${{ github.event.inputs.domain }}
          EXTRA_DOMAINS: ${{ github.event.inputs.extra_domains }}
        run: |
          echo "Archiving: $SITE_URL"
          if [ -n "$EXTRA_DOMAINS" ]; then
            echo "Including extra domains: $EXTRA_DOMAINS"
          else
            echo "No extra domains specified."
          fi

          # Split extra domains into array
          EXTRA_DOMAINS_ARRAY=()
          if [ -n "$EXTRA_DOMAINS" ]; then
            IFS=',' read -ra EXTRA_DOMAINS_ARRAY <<< "$EXTRA_DOMAINS"
          fi
          export EXTRA_DOMAINS=("${EXTRA_DOMAINS_ARRAY[@]}")

          # Run the download script
          bash download.sh

      - name: Update archive manifest
        run: |
          echo "ðŸ§¾ Generating archive manifest..."
          bash build-manifest.sh

      - name: Commit archived files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add archive
          git commit -m "Archived ${{ github.event.inputs.domain }} on $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push || (git pull --rebase origin main && git push)