{"version":3,"file":"app.js","sources":["../../../../source/ts/ManifestLoader.ts","../../../../source/ts/UrlUpdater.ts","../../../../source/ts/ArchiveController.ts","../../../../source/ts/app.ts"],"sourcesContent":["export class ManifestLoader {\n  async load(): Promise<Record<string, string[]>> {\n    const res = await fetch('./index.json');\n    if (!res.ok) {\n      throw new Error('Manifest not found');\n    }\n    return await res.json();\n  }\n}","export class UrlUpdater {\n  /**\n   * Formats the query string with URL encoding.\n   * Example: ?domain={encodedDomain}&url={encodedUrl}&date={encodedDate}\n   */\n  private formatHash(domain: string, url: string, date: string): string {\n    const enc = encodeURIComponent;\n    return `?domain=${enc(domain)}&url=${enc(url)}&date=${enc(date)}`;\n  }\n\n  /**\n   * Parses the query string format and returns the decoded values.\n   * Returns null if parsing fails or required fields are missing.\n   */\n  static parseHash(hash: string): { domain: string; url: string; date: string } | null {\n    if (!hash.startsWith('?')) return null;\n    // Remove \"?\"\n    const query = hash.slice(1);\n    const params = new URLSearchParams(query);\n    const domain = params.get('domain');\n    const url = params.get('url');\n    const date = params.get('date');\n    if (domain && url && date) {\n      return {\n        domain: decodeURIComponent(domain),\n        url: decodeURIComponent(url),\n        date: decodeURIComponent(date),\n      };\n    }\n    return null;\n  }\n\n  private normalizeUrl(src: string, domain: string, date: string): string {\n    if (!domain || !date) return '';\n    const prefix = `/${domain}/${date}/${domain}/`;\n\n    if (src.includes(prefix)) {\n      src = src.slice(src.indexOf(prefix) + prefix.length - 1);\n    }\n\n    if (!src.startsWith('/')) src = '/' + src;\n    if (src.endsWith('/index.html')) src = src.slice(0, -10);\n    if (src.endsWith('/') && src.length > 1) src = src.slice(0, -1);\n\n    return src;\n  }\n\n  update(src: string, domain: string, date: string): string {\n    const normalizedSrc = this.normalizeUrl(src, domain, date);\n    this.apply(domain, normalizedSrc, date);\n    return normalizedSrc;\n  }\n\n  apply(domain: string, src: string, date: string): void {\n    const newQuery = this.formatHash(domain, src, date);\n    const newUrl = `${window.location.pathname}${newQuery}`;\n    window.history.replaceState(null, '', newUrl);\n  }\n}","import { ManifestLoader } from './ManifestLoader';\nimport { UrlUpdater } from './UrlUpdater';\n\nexport class ArchiveController {\n  private manifest: Record<string, string[]> = {};\n  private domainSelect: HTMLSelectElement;\n  private dateSelect: HTMLSelectElement;\n  private preview: HTMLIFrameElement;\n  private urlDiv: HTMLElement;\n  private urlUpdater = new UrlUpdater();\n  private loader = new ManifestLoader();\n\n  constructor() {\n    this.domainSelect = document.getElementById('domain') as HTMLSelectElement;\n    this.dateSelect = document.getElementById('date') as HTMLSelectElement;\n    this.preview = document.getElementById('preview') as HTMLIFrameElement;\n    this.urlDiv = document.getElementById('url') as HTMLElement;\n  }\n\n  async init() {\n    try {\n      this.manifest = await this.loader.load();\n      this.populateDomains();\n      this.restoreSelection();\n      this.addListeners();\n    } catch (err: any) {\n      document.body.innerHTML = `<div id=\"manifest-error\">Could not load site index. Reason: ${err.message}</div>`;\n    }\n  }\n\n  private populateDomains() {\n    const domains = Object.keys(this.manifest).sort();\n    this.domainSelect.innerHTML =\n      '<option value=\"\">-- Select site --</option>' +\n      domains.map(d => `<option value=\"${d}\">${d}</option>`).join('');\n  }\n\n  private addListeners() {\n    this.domainSelect.addEventListener('change', () => this.onDomainChange());\n    this.dateSelect.addEventListener('change', () => this.loadArchive());\n    this.preview.addEventListener('load', () => this.onIframeLoad());\n    setInterval(() => this.syncUrl(), 500);\n  }\n\n  private onDomainChange() {\n    const domain = this.domainSelect.value;\n    const dates = this.manifest[domain] || [];\n    this.dateSelect.innerHTML = dates.map(d => `<option value=\"${d}\">${d}</option>`).join('');\n    if (dates.length) this.dateSelect.value = dates[dates.length - 1];\n    this.loadArchive();\n  }\n\n  private loadArchive() {\n    const domain = this.domainSelect.value;\n    const date = this.dateSelect.value;\n    if (!domain || !date) {\n      this.preview.src = '';\n      this.urlDiv.textContent = '';\n      return;\n    }\n    const src = `./${domain}/${date}/${domain}/index.html`;\n    this.preview.src = src;\n    localStorage.setItem('lastDomain', domain);\n    localStorage.setItem('lastDate', date);\n    this.urlDiv.textContent = this.urlUpdater.update(src, domain, date);\n  }\n\n  private onIframeLoad() {\n    this.preventExternalTargets();\n    try {\n      const iframeWindow = this.preview.contentWindow!;\n      const path = iframeWindow.location.pathname;\n      this.urlDiv.textContent = this.urlUpdater.update(path, this.domainSelect.value, this.dateSelect.value);\n    } catch {\n      throw new Error('Could not access iframe content');\n    }\n  }\n\n  private preventExternalTargets() {\n    try {\n      const doc = this.preview.contentDocument || this.preview.contentWindow?.document;\n      if (!doc) return;\n      const links = doc.querySelectorAll('a[target=\"_blank\"], a[target=\"_top\"], a[target=\"_parent\"]');\n      links.forEach(link => link.removeAttribute('target'));\n    } catch {}\n  }\n\n  private restoreSelection() {\n    const lastDomain = localStorage.getItem('lastDomain');\n    const lastDate = localStorage.getItem('lastDate');\n    if (lastDomain && this.manifest[lastDomain]) {\n      this.domainSelect.value = lastDomain;\n      const dates = this.manifest[lastDomain];\n      this.dateSelect.innerHTML = dates.map(d => `<option value=\"${d}\">${d}</option>`).join('');\n      if (lastDate && dates.includes(lastDate)) this.dateSelect.value = lastDate;\n      this.loadArchive();\n    }\n  }\n\n  private syncUrl() {\n    try {\n      const iframeWindow = this.preview.contentWindow!;\n      const path = iframeWindow.location.pathname;\n      const domain = this.domainSelect.value;\n      const date = this.dateSelect.value;\n      if (!domain || !date) return;\n      this.urlDiv.textContent = this.urlUpdater.update(path, domain, date);\n    } catch {}\n  }\n}","import { ArchiveController } from './ArchiveController';\nconst controller = new ArchiveController();\ncontroller.init();"],"names":[],"mappings":"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"}