<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Archive</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 0; }
  header { background: #f4f4f4; padding: 0.75rem 1rem; position: sticky; top: 0; display: flex; gap: 0.5rem; z-index: 10; align-items: center; border-bottom: 1px solid #ccc; }
  select, button { font-size: 1rem; padding: 0.3rem 0.5rem; }
  iframe { border: none; width: 100%; height: calc(100vh - 3rem); }
  h1 { font-size: 1.1rem; margin: 0 0.5rem 0 0; }
  h1 svg {
    height: 48px;
    width: 48px;
    color: #000;
    margin: 0 .5rem 0 0;
  }
  #manifest-error { 
    color: red; 
    padding: 1rem;
    top: 50%;
    position: absolute;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  #url {
    font-family: monospace;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-left: auto;
    color: #5c5c5c;
  }
</style>
</head>
<body>
  <header>
    <h1 class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000"><path d="m480-240 160-160-56-56-64 64v-168h-80v168l-64-64-56 56 160 160ZM200-640v440h560v-440H200Zm0 520q-33 0-56.5-23.5T120-200v-499q0-14 4.5-27t13.5-24l50-61q11-14 27.5-21.5T250-840h460q18 0 34.5 7.5T772-811l50 61q9 11 13.5 24t4.5 27v499q0 33-23.5 56.5T760-120H200Zm16-600h528l-34-40H250l-34 40Zm264 300Z"/></svg>
    </h1>
    <label>Domain:
      <select id="domain"></select>
    </label>
    <label>Date:
      <select id="date"></select>
    </label>
    <div id="url">
    </div>
  </header>
  <iframe id="preview" referrerpolicy="no-referrer"></iframe>

  <script>
    async function loadManifest() {
      const res = await fetch('./index.json');
      if (!res.ok) throw new Error('Manifest not found');
      return await res.json();
    }

    async function init() {
      const manifest = await loadManifest();
      const domainSelect = document.getElementById('domain');
      const dateSelect = document.getElementById('date');
      const preview = document.getElementById('preview');
      const urlDiv = document.getElementById('url');

      const domains = Object.keys(manifest).sort();
      domainSelect.innerHTML = '<option value="">-- Select site --</option>' + 
        domains.map(d => `<option value="${d}">${d}</option>`).join('');

      function updateUrlDisplay(src, domain, date) {
        if (!src || !domain || !date) {
          urlDiv.textContent = '';
          return;
        }
        // src format: ./domain/date/domain/index.html or possibly deeper paths
        // We want to extract the path after ./domain/date/domain/
        // Normalize src to remove leading ./ if present
        let prefix = `./${domain}/${date}/${domain}/`;
        let path = src.startsWith(prefix) ? src.slice(prefix.length - 2) : src;
        // Remove leading domain/date/domain prefix if present in src
        // Because src can be relative or absolute, handle both cases
        // If src is absolute or starts with "/", try to extract path accordingly
        if (src.startsWith(prefix)) {
          path = src.slice(prefix.length);
        } else if (src.startsWith('/')) {
          // If absolute path, try to remove /domain/date/domain/ prefix
          let absPrefix = `/${domain}/${date}/${domain}/`;
          if (src.startsWith(absPrefix)) {
            path = src.slice(absPrefix.length);
          } else {
            path = src;
          }
        } else {
          path = src;
        }
        // Ensure path starts with /
        if (!path.startsWith('/')) path = '/' + path;
        urlDiv.textContent = path;
      }

      domainSelect.addEventListener('change', () => {
        const domain = domainSelect.value;
        const dates = manifest[domain] || [];
        dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
        if (dates.length) dateSelect.value = dates[dates.length - 1];
        loadArchive();
      });

      dateSelect.addEventListener('change', loadArchive);

      function loadArchive() {
        const domain = domainSelect.value;
        const date = dateSelect.value;
        if (!domain || !date) {
          preview.src = '';
          urlDiv.textContent = '';
          return;
        }
        const baseSrc = `./${domain}/${date}/${domain}/index.html`;
        preview.src = baseSrc;
        localStorage.setItem('lastDomain', domain);
        localStorage.setItem('lastDate', date);
        updateUrlDisplay(baseSrc, domain, date);
      }

      // Restore previous selection
      const lastDomain = localStorage.getItem('lastDomain');
      const lastDate = localStorage.getItem('lastDate');
      if (lastDomain && manifest[lastDomain]) {
        domainSelect.value = lastDomain;
        const dates = manifest[lastDomain];
        dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
        if (lastDate && dates.includes(lastDate)) dateSelect.value = lastDate;
        loadArchive();
      }

      function preventExternalTargets(iframe) {
        try {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          if (!doc) return;
          const links = doc.querySelectorAll('a[target="_blank"], a[target="_top"], a[target="_parent"]');
          links.forEach(link => {
            link.removeAttribute('target');
          });
        } catch(e) {
          // Cross-origin, ignore
        }
      }

      preview.addEventListener('load', () => {
        preventExternalTargets(preview);

        try {
          const iframeWindow = preview.contentWindow;
          const iframeLocation = iframeWindow.location;
          const domain = domainSelect.value;
          const date = dateSelect.value;

          // Compute relative path by removing domain/date/domain prefix from iframeLocation.pathname
          // iframeLocation.pathname example: /domain/date/domain/some/path/index.html
          const prefix = `/${domain}/${date}/${domain}/`;
          let relPath = iframeLocation.pathname.startsWith(prefix) ? iframeLocation.pathname.slice(prefix.length - 1) : iframeLocation.pathname;
          // Ensure relPath starts with '/'
          if (!relPath.startsWith('/')) relPath = '/' + relPath;

          urlDiv.textContent = relPath;

          // Attach click listener to links to update url display on navigation inside iframe
          const doc = iframeWindow.document;
          if (doc) {
            doc.body.addEventListener('click', function(event) {
              const target = event.target.closest('a');
              if (!target) return;
              const href = target.getAttribute('href');
              if (!href || href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('javascript:')) return;
              event.preventDefault();
              let newUrl;
              if (href.startsWith('/')) {
                // Absolute path inside iframe origin
                newUrl = new URL(href, iframeLocation.origin).href;
              } else {
                // Relative path
                newUrl = new URL(href, iframeLocation.href).href;
              }
              iframeWindow.location.href = newUrl;
            }, true);
          }
        } catch(e) {
          // Cross-origin, ignore
        }
      });

      // Periodically update url display in case navigation happens programmatically
      setInterval(() => {
        try {
          const iframeWindow = preview.contentWindow;
          const iframeLocation = iframeWindow.location;
          const domain = domainSelect.value;
          const date = dateSelect.value;
          if (!domain || !date) return;
          const prefix = `/${domain}/${date}/${domain}/`;
          let relPath = iframeLocation.pathname.startsWith(prefix) ? iframeLocation.pathname.slice(prefix.length - 1) : iframeLocation.pathname;
          if (!relPath.startsWith('/')) relPath = '/' + relPath;
          if (urlDiv.textContent !== relPath) {
            urlDiv.textContent = relPath;
          }
        } catch(e) {
          // Cross-origin, ignore
        }
      }, 500);
    }

    init().catch(err => {
      document.body.innerHTML = '<div id="manifest-error">Could not load site index. Reason: ' + err.message + '</div>';
    });
  </script>
</body>
</html>